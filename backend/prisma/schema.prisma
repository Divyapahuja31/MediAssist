generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String               @id @default(uuid())
  email         String               @unique
  passwordHash  String
  role          String               @default("PATIENT") // PATIENT | CAREGIVER | ADMIN
  createdAt     DateTime             @default(now())

  // relations
  profile            Profile?
  devices            Device[]
  medications        Medication[]
  medicationSchedules MedicationSchedule[]
  prescriptions      Prescription[]
  adherenceLogs      AdherenceLog[]
}

model Profile {
  id                String   @id @default(uuid())
  userId            String   @unique
  name              String?
  phone             String?
  dob               DateTime? @db.Date
  bloodGroup        String?
  allergies         Json?
  emergencyContacts Json?
  createdAt         DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("profiles")
}

model Device {
  id            String   @id @default(uuid())
  userId        String
  expoPushToken String   @unique
  platform      String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("devices")
  @@index([userId])
}

model Medication {
  id           String               @id @default(uuid())
  userId       String
  name         String
  formulation  String?
  notes        String?
  stock        Int?
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt

  user         User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  schedules    MedicationSchedule[]
  prescriptions Prescription[]
  adherenceLogs AdherenceLog[]

  @@map("medications")
  @@index([userId])
}

model MedicationSchedule {
  id           String    @id @default(uuid())
  userId       String
  medicationId String

  startDate  DateTime? @db.Date
  endDate    DateTime? @db.Date
  timeOfDay  String?        // "08:00"
  timezone   String?        // "Asia/Kolkata"
  frequency  String?        // DAILY | WEEKLY | ONCE
  daysOfWeek Int[]          // [1, 3, 5] for Mon, Wed, Fri
  dosage     String?
  active     Boolean   @default(true)
  lastSent   DateTime?
  nextRunAt  DateTime?      // used by scheduler (UTC)
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  medication Medication @relation(fields: [medicationId], references: [id], onDelete: Cascade)

  adherenceLogs AdherenceLog[]

  @@map("medication_schedules")
  @@index([userId])
  @@index([medicationId])
  @@index([active])
  @@index([nextRunAt])
}

model Prescription {
  id           String   @id @default(uuid())
  userId       String
  medicationId String?
  storageKey   String
  filename     String?
  mimetype     String?
  size         Int?
  uploadedAt   DateTime @default(now())
  meta         Json?

  user       User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  medication Medication? @relation(fields: [medicationId], references: [id], onDelete: Cascade)

  @@map("prescriptions")
  @@index([userId])
  @@index([medicationId])
}

model AdherenceLog {
  id           String   @id @default(uuid())
  userId       String
  medicationId String?
  scheduleId   String?
  eventType    String      // "TAKEN" | "MISSED" | "DELIVERED"
  takenAt      DateTime @default(now())

  user        User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  medication  Medication?         @relation(fields: [medicationId], references: [id], onDelete: Cascade)
  schedule    MedicationSchedule? @relation(fields: [scheduleId], references: [id], onDelete: Cascade)

  @@map("adherence_logs")
  @@index([userId])
  @@index([medicationId])
  @@index([scheduleId])
}
